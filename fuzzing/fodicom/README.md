# FoDicomFuzzing
This repository allows for [fo-dicom](https://github.com/fo-dicom/fo-dicom) to be fuzzed with [AFL](https://github.com/google/AFL) utilizing [SharpFuzz](https://github.com/Metalnem/sharpfuzz) as wrapper for the C# language.

## Requirements
Since fo-dicom communicates via network a socket is required to supply the raw byte data generated by AFL to the DicomClient. The scripts in this repository use `medfuzz` to do just that. Any other requirements should be managed by the scripts in this repository, see section _Usage_ for details.

## Usage
There are two frameworks to execute C# applications: [dotnet](https://dotnet.microsoft.com/) and [mono](https://www.mono-project.com/).
The [dotnet_mono_utils.sh](dotnet_mono_utils.sh) script is sourced in every other script as a basic dependency to determine the framework used to build and run the C# applications. It prefers dotnet over mono, if both are installed and also inhibits further execution if both are missing.

Helpful information for troubleshooting SharpFuzz related problems and fuzzing C# applications in general can be in the [SharpFuzz repository on github](https://github.com/Metalnem/sharpfuzz#usage).

### Setting up the fuzzing environment (setup_fo-dicom.sh)
After pulling the latest commit of the fo-dicom repository and building it, the built dll will be copied to a directory, which defaults to the name `fo-fuzz`. In there a C# project file (.csproj) will be created along with the code file [Program.cs copied from the fo-dicom_template directory](fo-fuzz_template/Program.cs). The .csproj file will reference the local copy of the previously built fo-dicom dll.
In order to make this fo-dicom library fuzzable the dll is instrumented by SharpFuzz.
The `Program.cs` constitutes the source code for a stub application which serves as fuzzing target. In there calls to the instrumented dll will be made inside of the `Fuzzer.Run({ ... })` statement. Uncaught exceptions originating from this Action body will be reported to AFL as a crash by SharpFuzz.

### Instrumenting the target library under test (instrument_dll.sh)
This script automatically instruments the fo-dicom library. If necessary the script automatically downloads and builds [SharpFuzz](https://github.com/Metalnem/sharpfuzz).

### Fuzzing (fuzz_fodicom.sh)
This script is a modified version of the script used by [DicomFuzzing](https://git.noc.ruhr-uni-bochum.de/gierlmds/dicomfuzzing) to start the actual fuzzing process. It uses a ramdisk to improve performance, checks all prerequisites, starts the medfuzz network interface(s) and finally the afl-fuzz process(es) which do the fuzzing work.

### Debugging your Application
You might want to debug your Program.cs. Unfortunately you can not debug the fuzzable build.

There are two different .csproj files inside the [fo-fuzz](fo-fuzz) directory.
The [fo-fuzz/fo-fuzz.csproj](fo-fuzz_template/fo-fuzz.csproj) is the default project file generated by [setup_fo-dicom.sh](setup_fo-dicom.sh). It references the instrumented fo-dicom dll. There also is a commented out reference to the libraries' source code.

If you want to debug the application and therefore most likely the fo-dicom library you will have to use either of the following options
- comment out the library dll and uncomment the source code reference
- use the [fo-fuzz_template/fo-fuzz.dbg.csproj](fo-fuzz/fo-fuzz.dbg.csproj) since it references the fo-dicom source code instead of the dll.


